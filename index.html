<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz Ingl√©s</title>

<style>
/* ========================= */
/*        VARIABLES          */
/* ========================= */
:root {
  --bg:#071226;
  --panel:#0f1724;
  --card:#0b1220;
  --fg:#e6eef8;
  --muted:#9aa7bf;
  --accent:#3b82f6;
  --good:#10b981;
  --danger:#ef4444;
  --glass:rgba(255,255,255,0.03);
}

.light {
  --bg:#f3f6fb;
  --panel:#ffffff;
  --card:#ffffff;
  --fg:#0b1220;
  --muted:#475569;
  --accent:#2563eb;
  --glass:rgba(0,0,0,0.04);
}

/* ========================= */
/*         BASE              */
/* ========================= */
*{ box-sizing:border-box; }
html, body {
  margin:0;
  font-family:Inter, "Segoe UI", sans-serif;
  background:var(--bg);
  color:var(--fg);
  height:100%;
}

body {
  padding:20px;
  display:flex;
  justify-content:center;
  align-items:center;
}

.app {
  width:100%;
  max-width:1150px;
  min-height:600px;
  padding:18px;
  border-radius:14px;
  background:var(--panel);
  box-shadow:0 18px 45px rgba(0,0,0,0.45);
  display:grid;
  grid-template-columns:320px 1fr;
  gap:18px;
}

/* ========================= */
/*         HEADER            */
/* ========================= */
header {
  grid-column:1 / -1;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.brand h1 {
  margin:0;
  font-size:22px;
}

.brand-sub {
  font-size:13px;
  color:var(--muted);
}

.theme-area {
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--muted);
}

/* ========================= */
/*         SIDEBAR           */
/* ========================= */
.profiles-panel {
  background:var(--card);
  padding:14px;
  border-radius:10px;
}

.profiles-panel h2 { margin:0 0 8px 0; }

.profiles-list {
  max-height:350px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.profile-btn {
  border:1px solid var(--glass);
  background:transparent;
  color:var(--fg);
  padding:10px;
  border-radius:10px;
  text-align:left;
  cursor:pointer;
  transition:0.15s;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.profile-btn:hover {
  background:var(--glass);
  transform:translateY(-2px);
}

/* Crear perfil */
.create-row {
  margin-top:12px;
  display:flex;
  gap:8px;
}

.create-row input {
  padding:8px;
  border-radius:8px;
  border:1px solid var(--glass);
  background:transparent;
  color:var(--fg);
}

/* Solo queda bot√≥n ranking global */
.rank-tools {
  margin-top:12px;
  display:flex;
  gap:8px;
}

/* ========================= */
/*         MAIN PANEL        */
/* ========================= */
.main-panel {
  background:var(--card);
  padding:18px;
  border-radius:10px;
  overflow-y:auto;
}

.card {
  background:var(--glass);
  padding:14px;
  border-radius:10px;
}

.leaderboard {
  display:flex;
  flex-direction:column;
  gap:8px;
}

.leader-row {
  display:flex;
  justify-content:space-between;
  padding:8px;
  background:var(--glass);
  border-radius:8px;
}

/* ========================= */
/*         BUTTONS           */
/* ========================= */
.btn {
  padding:8px 12px;
  border:0;
  cursor:pointer;
  border-radius:8px;
  font-size:14px;
}

.accent {
  background:var(--accent);
  color:white;
  box-shadow:0 0 12px rgba(59,130,246,0.4);
}

.ghost {
  border:1px solid var(--glass);
  background:transparent;
  color:var(--fg);
}

.small { font-size:13px; }

/* ========================= */
/*         QUESTIONS         */
/* ========================= */
.question {
  font-size:19px;
  margin:8px 0 14px 0;
}

.options {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.option-btn {
  padding:12px;
  border-radius:10px;
  border:1px solid var(--glass);
  background:transparent;
  color:var(--fg);
  cursor:pointer;
  font-size:15px;
  text-align:left;
  transition:0.15s;
}

.option-btn:hover {
  background:var(--glass);
  transform:translateY(-3px);
}

.option-btn.correct {
  background:rgba(16,185,129,0.18);
  border-left:4px solid var(--good);
}

.option-btn.wrong {
  background:rgba(239,68,68,0.18);
  border-left:4px solid var(--danger);
}

/* Timer */
.timerbar {
  height:10px;
  background:var(--glass);
  border-radius:6px;
  overflow:hidden;
  margin-top:12px;
}

.timerfill {
  height:100%;
  background:linear-gradient(90deg,var(--accent), #60a5fa);
  width:100%;
  transition:width 1s linear;
}

/* ========================= */
/*           MODAL           */
/* ========================= */
.modal-overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal-window {
  background:var(--card);
  width:350px;
  max-width:90%;
  border-radius:12px;
  padding:18px;
  box-shadow:0 18px 40px rgba(0,0,0,0.5);
}

.modal-message {
  margin-bottom:14px;
  font-size:15px;
}

.modal-actions {
  display:flex;
  justify-content:flex-end;
  gap:10px;
}

.hidden { display:none !important; }

/* ========================= */
/* ANIMACIONES */
/* ========================= */
.fade-in { animation:fadeIn .35s ease both; }
.slide-up { animation:slideUp .45s ease both; }
.scale-in { animation:scaleIn .35s ease both; }

@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:none;} }
@keyframes slideUp { from {opacity:0; transform:translateY(16px);} to {opacity:1; transform:none;} }
@keyframes scaleIn { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }

/* ========================= */
/* RESPONSIVE */
/* ========================= */
@media (max-width:900px){
  .app { grid-template-columns:1fr; padding:12px; }
  .profiles-panel { order:2; }
  .main-panel { order:1; }
}
</style>

</head>
<body>
<div class="app">

<header class="fade-in">
  <div class="brand"><h1>Quiz Ingl√©s</h1></div>
  <div class="theme-area">
    <label>Tema claro</label>
    <input id="themeToggle" type="checkbox">
  </div>
</header>

<!-- SIDEBAR -->
<aside class="profiles-panel slide-up">
  <h2>Perfiles</h2>

  <div id="profilesList" class="profiles-list"></div>

  <div class="create-row">
    <input id="inputProfile" placeholder="Nombre del jugador">
    <button id="btnCreateProfile" class="btn accent">‚ûï Crear</button>
  </div>

  <div class="rank-tools">
    <button id="btnGlobalRank" class="btn accent small">üåç Ranking global</button>
  </div>

  <div class="muted small info-pin">
    Se utiliza un PIN num√©rico de 4 d√≠gitos para entrar al perfil.
  </div>
</aside>

<main class="main-panel slide-up" id="mainPanel">
  <div id="mainContent">
    <div class="card fade-in">
      <h2>Bienvenido üëã</h2>
      <p class="muted">Selecciona o crea un perfil.  
      El ranking refleja el tiempo acumulado (menor = mejor).</p>
    </div>

    <div class="card fade-in" style="margin-top:12px">
      <h3>Ranking local</h3>
      <div id="leaderboard" class="leaderboard muted">Cargando...</div>
    </div>
  </div>
</main>
</div>

<!-- MODAL -->
<div id="modalOverlay" class="modal-overlay hidden">
  <div class="modal-window scale-in">
    <div id="modalMessage" class="modal-message"></div>
    <div class="modal-actions">
      <button id="modalOk" class="btn accent">Aceptar</button>
      <button id="modalCancel" class="btn ghost hidden">Cancelar</button>
    </div>
  </div>
</div>

<!-- AUDIO -->
<audio id="sndCorrect"></audio>
<audio id="sndWrong"></audio>
<audio id="sndTime"></audio>

<!-- SCRIPT INICIA AQU√ç -->
<script type="module">

/* ========== FIREBASE ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAoYaWXxQhqe7FZbyA_qBE3Hz6iJgONV3c",
  authDomain: "quizenglish-f4708.firebaseapp.com",
  projectId: "quizenglish-f4708",
  storageBucket: "quizenglish-f4708.firebasestorage.app",
  messagingSenderId: "992301935930",
  appId: "1:992301935930:web:bd3965a3dabf8937743403"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const sndCorrect = document.getElementById("sndCorrect");
const sndWrong   = document.getElementById("sndWrong");
const sndTime    = document.getElementById("sndTime");

sndCorrect.src = "https://cdn.pixabay.com/download/audio/2022/07/04/audio_06fbc2436a.mp3?filename=correct-2-46134.mp3";
sndWrong.src   = "https://cdn.pixabay.com/download/audio/2022/03/15/audio_6da5fd77f2.mp3?filename=error-126627.mp3";
sndTime.src    = "https://cdn.pixabay.com/download/audio/2022/03/15/audio_18f3d1063f.mp3?filename=beep-warning-6387.mp3";

/* ============================================================
   MODAL
============================================================ */
const modalOverlay = document.getElementById("modalOverlay");
const modalMessage = document.getElementById("modalMessage");
const modalOk      = document.getElementById("modalOk");
const modalCancel  = document.getElementById("modalCancel");

function showModal(text, cancel = false) {
  modalMessage.textContent = text;
  modalCancel.classList.toggle("hidden", !cancel);
  modalOverlay.classList.remove("hidden");
  return new Promise(res => {
    modalOk.onclick = () => { modalOverlay.classList.add("hidden"); res(true); };
    modalCancel.onclick = () => { modalOverlay.classList.add("hidden"); res(false); };
  });
}

/* ============================================================
   VARIABLES GLOBALES
============================================================ */
let profiles = JSON.parse(localStorage.getItem("profiles") || "[]");
let currentProfile = null;

let questions = [];        // cuestionario activo
let qIndex     = 0;
let timerInt   = null;
let timeLeft   = 15;
let wrongCount = 0;
let totalTime  = 0;

/* ============================================================
   PERFILES
============================================================ */
const elProfilesList = document.getElementById("profilesList");
const elInputProfile = document.getElementById("inputProfile");
const elBtnCreate    = document.getElementById("btnCreateProfile");

elBtnCreate.onclick = async () => {
  const name = elInputProfile.value.trim();
  if (!name) return;

  const pin = Math.floor(1000 + Math.random() * 9000).toString();

  profiles.push({
    name,
    pin,
    total: 0,
    wrongs: 0,
    games: 0
  });

  localStorage.setItem("profiles", JSON.stringify(profiles));

  await showModal(`Perfil creado.\nPIN: ${pin}`);
  elInputProfile.value = "";
  renderProfiles();
  renderLeaderboard();
};

function renderProfiles() {
  elProfilesList.innerHTML = "";
  profiles.forEach(p => {
    const b = document.createElement("button");
    b.className = "profile-btn";
    b.textContent = p.name;
    b.onclick = () => accessProfile(p);
    elProfilesList.appendChild(b);
  });
}
renderProfiles();

/* ============================================================
   ACCESO A PERFIL CON PIN
============================================================ */
async function accessProfile(p) {
  const ok = await showModal(`Introduce el PIN para entrar en "${p.name}"`, true);
  if (!ok) return;

  const pin = prompt("PIN de 4 d√≠gitos:");
  if (pin === p.pin) {
    currentProfile = p;
    loadProfilePanel();
  } else {
    showModal("PIN incorrecto");
  }
}

/* ============================================================
   PANEL DEL PERFIL
============================================================ */
const elMain = document.getElementById("mainContent");

function loadProfilePanel() {
  elMain.innerHTML = `
    <div class="card">
      <h2>Perfil: ${currentProfile.name}</h2>
      <p class="muted">Juegos jugados: ${currentProfile.games}</p>
      <p class="muted">Tiempo total acumulado: ${currentProfile.total}s</p>
      <p class="muted">Incorrectas acumuladas: ${currentProfile.wrongs}</p>

      <button id="btnStart" class="btn accent" style="margin-top:10px">
        ‚ñ∂Ô∏è Iniciar partida
      </button>
    </div>
  `;

  document.getElementById("btnStart").onclick = startGame;
}

/* ============================================================
   RANKING LOCAL
============================================================ */
function renderLeaderboard() {
  const el = document.getElementById("leaderboard");
  if (!profiles.length) {
    el.innerHTML = "<p class='muted'>Sin jugadores</p>";
    return;
  }
  const sorted = [...profiles].sort((a,b) => a.total - b.total);

  el.innerHTML = "";
  sorted.forEach((p,i) => {
    const row = document.createElement("div");
    row.className = "leader-row";
    row.innerHTML = `
      <span>${i+1}. ${p.name}</span>
      <span>${p.total}s</span>
    `;
    el.appendChild(row);
  });
}
renderLeaderboard();

/* ============================================================
   PREGUNTAS DEMO (puedes reemplazar)
============================================================ */
const BASE_QUESTIONS = [
  { q:"Dog", a:["Perro","Gato","Mesa"], c:0 },
  { q:"House", a:["Casa","Carro","Sombrero"], c:0 },
  { q:"Apple", a:["Manzana","Escuela","Zapato"], c:0 },
  { q:"Water", a:["Agua","Nieve","Humo"], c:0 },
];

/* ============================================================
   INICIO DEL JUEGO
============================================================ */
function startGame() {
  questions = BASE_QUESTIONS.sort(()=>Math.random()-0.5);
  qIndex = 0;
  totalTime = 0;
  wrongCount = 0;

  loadQuestion();
}

/* ============================================================
   MOSTRAR PREGUNTA
============================================================ */
function loadQuestion() {
  const q = questions[qIndex];

  elMain.innerHTML = `
    <div class="card">
      <h2>Pregunta ${qIndex+1}/${questions.length}</h2>
      <div class="question">${q.q}</div>

      <div class="options">
        ${q.a.map((t,i)=>`<button class="option-btn" data-i="${i}">${t}</button>`).join("")}
      </div>

      <div class="timerbar"><div id="timerFill" class="timerfill"></div></div>
    </div>
  `;

  startTimer();

  document.querySelectorAll(".option-btn").forEach(btn => {
    btn.onclick = () => answer(btn.dataset.i);
  });
}

/* ============================================================
   TIMER
============================================================ */
function startTimer() {
  timeLeft = 15;
  updateTimerBar();

  clearInterval(timerInt);
  timerInt = setInterval(() => {
    timeLeft--;
    updateTimerBar();

    if (timeLeft === 3) sndTime.play();

    if (timeLeft <= 0) {
      clearInterval(timerInt);
      wrongCount++;
      nextQuestion();
    }
  },1000);
}

function updateTimerBar() {
  const bar = document.getElementById("timerFill");
  if (bar) bar.style.width = (timeLeft/15)*100 + "%";
}

/* ============================================================
   RESPUESTA
============================================================ */
function answer(i) {
  clearInterval(timerInt);

  const q = questions[qIndex];
  const buttons = document.querySelectorAll(".option-btn");

  buttons.forEach(b => b.disabled = true);

  if (Number(i) === q.c) {
    sndCorrect.play();
    buttons[i].classList.add("correct");
  } else {
    sndWrong.play();
    wrongCount++;
    buttons[i].classList.add("wrong");
    buttons[q.c].classList.add("correct");
  }

  totalTime += (15 - timeLeft);

  setTimeout(nextQuestion, 1000);
}

/* ============================================================
   SIGUIENTE PREGUNTA
============================================================ */
function nextQuestion() {
  qIndex++;
  if (qIndex >= questions.length) finishGame();
  else loadQuestion();
}

/* ============================================================
   FINALIZAR PARTIDA
============================================================ */
async function finishGame() {
  currentProfile.games++;
  currentProfile.wrongs += wrongCount;
  currentProfile.total  += totalTime;

  localStorage.setItem("profiles", JSON.stringify(profiles));

  await saveGlobalRanking(
    currentProfile.name,
    totalTime,
    questions.length - wrongCount,
    wrongCount
  );

  showResults();
  renderLeaderboard();
}

/* ============================================================
   MOSTRAR RESULTADOS
============================================================ */
function showResults() {
  elMain.innerHTML = `
    <div class="card scale-in">
      <h2>Resultados</h2>
      <p>Tiempo total: ${totalTime}s</p>
      <p>Correctas: ${questions.length - wrongCount}</p>
      <p>Incorrectas: ${wrongCount}</p>

      <button class="btn accent" id="btnBack">Volver</button>
    </div>
  `;

  document.getElementById("btnBack").onclick = loadProfilePanel;
}

/* ============================================================
   FIREBASE ‚Äî GUARDAR RANKING GLOBAL
============================================================ */
async function saveGlobalRanking(name, time, correct, wrong) {
  try {
    await addDoc(collection(db, "globalRanking"), {
      name,
      time,
      correct,
      wrong,
      date: Date.now()
    });
  } catch (e) {
    console.error("Error guardando en ranking global:", e);
  }
}

/* ============================================================
   FIREBASE ‚Äî LEER RANKING GLOBAL
============================================================ */
async function loadGlobalRanking() {
  try {
    const q = query(
      collection(db, "globalRanking"),
      orderBy("time", "asc")
    );

    const snap = await getDocs(q);

    let html = "";

    snap.forEach(doc => {
      const d = doc.data();
      html += `
        <div class="leader-row">
          <span>${d.name}</span>
          <span>${d.time}s</span>
        </div>
      `;
    });

    if (!html) html = `<p class="muted">Sin registros a√∫n</p>`;

    showGlobalRankingModal(html);

  } catch (e) {
    console.error("Error cargando ranking global:", e);
    showModal("No se pudo conectar con el ranking global");
  }
}

/* ============================================================
   MODAL DE RANKING GLOBAL
============================================================ */
function showGlobalRankingModal(content) {
  modalMessage.innerHTML = `
    <strong>üåç Ranking global</strong>
    <div style="margin-top:12px; max-height:260px; overflow-y:auto;">
      ${content}
    </div>
  `;
  modalCancel.classList.add("hidden");
  modalOverlay.classList.remove("hidden");

  modalOk.onclick = () => modalOverlay.classList.add("hidden");
}

/* Evento del bot√≥n */
document.getElementById("btnGlobalRank").onclick = loadGlobalRanking;

/* ============================================================
   TEMA CLARO / OSCURO
============================================================ */
const themeToggle = document.getElementById("themeToggle");

themeToggle.checked = localStorage.getItem("themeLight") === "1";
applyTheme();

themeToggle.onchange = () => {
  localStorage.setItem("themeLight", themeToggle.checked ? "1":"0");
  applyTheme();
};

function applyTheme() {
  if (localStorage.getItem("themeLight") === "1")
    document.body.classList.add("light");
  else
    document.body.classList.remove("light");
}

/* ============================================================
   FIN DEL SCRIPT
============================================================ */
</script>

</body>
</html>
