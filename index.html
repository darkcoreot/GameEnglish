<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz Ingl√©s</title>

<!-- CSS llegar√° en la PARTE 2 -->
<style>
/* ========================= */
/*        VARIABLES          */
/* ========================= */
:root {
  --bg:#071226;
  --panel:#0f1724;
  --card:#0b1220;
  --fg:#e6eef8;
  --muted:#9aa7bf;
  --accent:#3b82f6;
  --good:#10b981;
  --danger:#ef4444;
  --glass:rgba(255,255,255,0.03);
}

.light {
  --bg:#f3f6fb;
  --panel:#ffffff;
  --card:#ffffff;
  --fg:#0b1220;
  --muted:#475569;
  --accent:#2563eb;
  --glass:rgba(0,0,0,0.04);
}

/* ========================= */
/*         BASE              */
/* ========================= */
*{ box-sizing:border-box; }
html, body {
  margin:0;
  font-family:Inter, "Segoe UI", sans-serif;
  background:var(--bg);
  color:var(--fg);
  height:100%;
}

body {
  padding:20px;
  display:flex;
  justify-content:center;
  align-items:center;
}

.app {
  width:100%;
  max-width:1150px;
  min-height:600px;
  padding:18px;
  border-radius:14px;
  background:var(--panel);
  box-shadow:0 18px 45px rgba(0,0,0,0.45);
  display:grid;
  grid-template-columns:320px 1fr;
  gap:18px;
}

/* ========================= */
/*         HEADER            */
/* ========================= */
header {
  grid-column:1 / -1;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.brand h1 {
  margin:0;
  font-size:22px;
}

.brand-sub {
  font-size:13px;
  color:var(--muted);
}

.theme-area {
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--muted);
}

/* ========================= */
/*         SIDEBAR           */
/* ========================= */
.profiles-panel {
  background:var(--card);
  padding:14px;
  border-radius:10px;
}

.profiles-panel h2 { margin:0 0 8px 0; }

.profiles-list {
  max-height:350px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.profile-btn {
  border:1px solid var(--glass);
  background:transparent;
  color:var(--fg);
  padding:10px;
  border-radius:10px;
  text-align:left;
  cursor:pointer;
  transition:0.15s;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.profile-btn:hover {
  background:var(--glass);
  transform:translateY(-2px);
}

/* Crear perfil */
.create-row {
  margin-top:12px;
  display:flex;
  gap:8px;
}

.create-row input {
  padding:8px;
  border-radius:8px;
  border:1px solid var(--glass);
  background:transparent;
  color:var(--fg);
}

.rank-tools {
  margin-top:12px;
  display:flex;
  gap:8px;
}

.info-pin {
  margin-top:12px;
}

/* ========================= */
/*         MAIN PANEL        */
/* ========================= */
.main-panel {
  background:var(--card);
  padding:18px;
  border-radius:10px;
  overflow-y:auto;
}

.card {
  background:var(--glass);
  padding:14px;
  border-radius:10px;
}

.leaderboard {
  display:flex;
  flex-direction:column;
  gap:8px;
}

.leader-row {
  display:flex;
  justify-content:space-between;
  padding:8px;
  background:var(--glass);
  border-radius:8px;
}

/* ========================= */
/*         BUTTONS           */
/* ========================= */
.btn {
  padding:8px 12px;
  border:0;
  cursor:pointer;
  border-radius:8px;
  font-size:14px;
}

.accent {
  background:var(--accent);
  color:white;
  box-shadow:0 0 12px rgba(59,130,246,0.4);
}

.ghost {
  border:1px solid var(--glass);
  background:transparent;
  color:var(--fg);
}

.small { font-size:13px; }

/* ========================= */
/*         QUESTIONS         */
/* ========================= */
.question {
  font-size:19px;
  margin:8px 0 14px 0;
}

.options {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.option-btn {
  padding:12px;
  border-radius:10px;
  border:1px solid var(--glass);
  background:transparent;
  color:var(--fg);
  cursor:pointer;
  font-size:15px;
  text-align:left;
  transition:0.15s;
}

.option-btn:hover {
  background:var(--glass);
  transform:translateY(-3px);
}

.option-btn.correct {
  background:rgba(16,185,129,0.18);
  border-left:4px solid var(--good);
}

.option-btn.wrong {
  background:rgba(239,68,68,0.18);
  border-left:4px solid var(--danger);
}

/* Timer */
.timerbar {
  height:10px;
  background:var(--glass);
  border-radius:6px;
  overflow:hidden;
  margin-top:12px;
}

.timerfill {
  height:100%;
  background:linear-gradient(90deg,var(--accent), #60a5fa);
  width:100%;
  transition:width 1s linear;
}

/* ========================= */
/*           MODAL           */
/* ========================= */
.modal-overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal-window {
  background:var(--card);
  width:350px;
  max-width:90%;
  border-radius:12px;
  padding:18px;
  box-shadow:0 18px 40px rgba(0,0,0,0.5);
}

.modal-message {
  margin-bottom:14px;
  font-size:15px;
}

.modal-actions {
  display:flex;
  justify-content:flex-end;
  gap:10px;
}

.hidden { display:none !important; }

/* ========================= */
/*      ANIMACIONES          */
/* ========================= */
.fade-in { animation:fadeIn .35s ease both; }
.slide-up { animation:slideUp .45s ease both; }
.scale-in { animation:scaleIn .35s ease both; }

@keyframes fadeIn {
  from {opacity:0; transform:translateY(10px);}
  to {opacity:1; transform:none;}
}
@keyframes slideUp {
  from {opacity:0; transform:translateY(16px);}
  to {opacity:1; transform:none;}
}
@keyframes scaleIn {
  from {opacity:0; transform:scale(0.8);}
  to {opacity:1; transform:scale(1);}
}

/* ========================= */
/*       RESPONSIVE          */
/* ========================= */
@media (max-width:900px){
  .app {
    grid-template-columns:1fr;
    padding:12px;
  }
  .profiles-panel { order:2; }
  .main-panel { order:1; }
}

</style>

</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header class="fade-in">
    <div class="brand">
      <h1>Quiz Ingl√©s </h1>
    </div>

    <div class="theme-area">
      <label>Tema claro</label>
      <input id="themeToggle" type="checkbox">
    </div>
  </header>

  <!-- SIDEBAR PERFILES -->
  <aside class="profiles-panel slide-up">
    <h2>Perfiles</h2>

    <div id="profilesList" class="profiles-list"></div>

    <!-- Crear perfil -->
    <div class="create-row">
      <input id="inputProfile" placeholder="Nombre del jugador">
      <button id="btnCreateProfile" class="btn accent">‚ûï Crear</button>
    </div>

    <!-- Ranking local export/import (REEMPLAZADO por Ranking global) -->
    <div class="rank-tools">
      <button id="btnGlobalRank" class="btn accent small">üåç Ranking global</button>
    </div>

    <div class="muted small info-pin">
      Se utiliza un PIN num√©rico de 4 d√≠gitos para entrar al perfil.
    </div>
  </aside>

  <!-- PANEL PRINCIPAL -->
  <main class="main-panel slide-up" id="mainPanel">
    <div id="mainContent">
      <div class="card fade-in">
        <h2>Bienvenido üëã</h2>
        <p class="muted">
          Selecciona o crea un perfil.  
          El ranking refleja el tiempo acumulado (menor = mejor).
        </p>
      </div>

      <div class="card fade-in" style="margin-top:12px">
        <h3>Ranking local</h3>
        <div id="leaderboard" class="leaderboard muted">Cargando...</div>
      </div>
    </div>
  </main>

</div>

<!-- =============== MODAL CUSTOM =============== -->
<div id="modalOverlay" class="modal-overlay hidden">
  <div class="modal-window scale-in" id="modalWindow">
    <div id="modalMessage" class="modal-message"></div>
    <div class="modal-actions">
      <button id="modalOk" class="btn accent">Aceptar</button>
      <button id="modalCancel" class="btn ghost hidden">Cancelar</button>
    </div>
  </div>
</div>

<!-- =============== AUDIO SONIDOS =============== -->
<audio id="sndCorrect"></audio>
<audio id="sndWrong"></audio>
<audio id="sndTime"></audio>
<!-- Firebase App + Firestore -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAoYaWXxQhqe7FZbyA_qBE3Hz6iJgONV3c",
  authDomain: "quizenglish-f4708.firebaseapp.com",
  projectId: "quizenglish-f4708",
  storageBucket: "quizenglish-f4708.firebasestorage.app",
  messagingSenderId: "992301935930",
  appId: "1:992301935930:web:bd3965a3dabf8937743403"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<!-- JS COMPLETO VIENE EN PARTE 3 -->
<script>
async function guardarEnRankingGlobal(nombre, tiempo_total, correctas, incorrectas) {
  try {
    await db.collection("ranking").add({
      nombre: nombre,
      tiempo_total: tiempo_total,
      correctas: correctas,
      incorrectas: incorrectas,
      fecha: Date.now()
    });
    console.log("‚úî Puntaje guardado en ranking global");
  } catch (error) {
    console.error("‚ùå Error guardando ranking:", error);
  }
}


const sndCorrect = document.getElementById("sndCorrect");
sndCorrect.src =
"data:audio/wav;base64,UklGRl4AAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="; 
// sonido simple click ok

const sndWrong = document.getElementById("sndWrong");
sndWrong.src =
"data:audio/wav;base64,UklGRl4AAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=";
// sonido simple error (puedes reemplazar luego por otro)

const sndTime = document.getElementById("sndTime");
sndTime.src =
"data:audio/wav;base64,UklGRl4AAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=";
// sonido simple timeout

/* ---------- MODAL BONITO ---------- */
const modalOverlay = document.getElementById("modalOverlay");
const modalWindow = document.getElementById("modalWindow");
const modalMessage = document.getElementById("modalMessage");
const modalOk = document.getElementById("modalOk");
const modalCancel = document.getElementById("modalCancel");

function showModal(message, withCancel = false) {
  modalMessage.innerHTML = message;
  modalOverlay.classList.remove("hidden");
  modalCancel.classList.toggle("hidden", !withCancel);
  return new Promise(resolve => {
    modalOk.onclick = () => {
      modalOverlay.classList.add("hidden");
      resolve(true);
    };
    modalCancel.onclick = () => {
      modalOverlay.classList.add("hidden");
      resolve(false);
    };
  });
}

/* ---------- UTILIDADES ---------- */
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatNum(n){ return Number(n).toFixed(2); }

/* --- hash PIN --- */
async function hashPin(pin){
  const enc = new TextEncoder().encode(pin);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ---------- STORAGE ---------- */
const STATE_KEY = "quiz_v4_state";
const LEADER_KEY = "quiz_v4_leaderboard";

let state = { perfiles:{} };
try{ state = JSON.parse(localStorage.getItem(STATE_KEY)) || state; }catch(e){}
function saveState(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }

let leaderboard = [];
try{ leaderboard = JSON.parse(localStorage.getItem(LEADER_KEY)) || []; }catch(e){}
function saveLeader(){ localStorage.setItem(LEADER_KEY, JSON.stringify(leaderboard)); }

/* ---------- DOM ---------- */
const profilesList = document.getElementById("profilesList");
const inputProfile = document.getElementById("inputProfile");
const btnCreateProfile = document.getElementById("btnCreateProfile");
const mainContent = document.getElementById("mainContent");
const leaderboardEl = document.getElementById("leaderboard");
/* btnExport and btnImport were removed */
const btnGlobalRank = document.getElementById("btnGlobalRank");
const themeToggle = document.getElementById("themeToggle");

/* ---------- Cargar preguntas desde archivo externo ---------- */
let PREGUNTAS = null;
let loadedQuestions = false;

async function loadQuestions(){
  try{
    const r = await fetch("preguntas.json", {cache:"no-store"});
    if(!r.ok) throw new Error("Error HTTP");
    PREGUNTAS = await r.json();
    loadedQuestions = true;
  }catch(e){
    showModal("‚ö†Ô∏è No se pudo cargar <strong>preguntas.json</strong>.<br>Verifica que el archivo existe en la misma carpeta del index.html.");
    loadedQuestions = false;
  }
}
loadQuestions();

/* ---------- Render Perfiles ---------- */
function renderProfiles(){
  profilesList.innerHTML = "";
  const keys = Object.keys(state.perfiles).sort();
  if(keys.length === 0){
    profilesList.innerHTML = '<div class="muted small">No hay perfiles a√∫n.</div>';
    return;
  }
  keys.forEach(name=>{
    const p = state.perfiles[name];
    const btn = document.createElement("button");
    btn.className = "profile-btn";
    btn.innerHTML = `
      <div><strong>${esc(name)}</strong><div class="muted small">${p.nivel.toUpperCase()}</div></div>
      <div><div class="muted small">‚úî ${p.correctas}</div><div class="muted small">‚úñ ${p.incorrectas}</div></div>
    `;
    btn.onclick = ()=> promptPinAndEnter(name);
    profilesList.appendChild(btn);
  });
}

/* ---------- Crear Perfil ---------- */
btnCreateProfile.onclick = async ()=>{
  const name = inputProfile.value.trim();
  if(!name) return showModal("Ingresa un nombre v√°lido.");
  if(state.perfiles[name]) return showModal("Ese perfil ya existe.");

  let pin = prompt("Crea un PIN de 4 d√≠gitos:");
  if(pin===null) return;
  if(!/^\d{4}$/.test(pin)) return showModal("PIN inv√°lido (debe ser 4 d√≠gitos).");

  const h = await hashPin(pin);

  state.perfiles[name] = {
    nivel:"basico",
    correctas:0,
    incorrectas:0,
    tiempo_total:0,
    total_respuestas:0,
    idx_pregunta:0,
    finished_all:false,
    pinHash:h
  };

  saveState();
  inputProfile.value = "";
  renderProfiles();
  showModal("Perfil creado correctamente.");
};

/* ---------- Entrar con PIN ---------- */
async function promptPinAndEnter(name){
  const p = state.perfiles[name];

  let pin = prompt("Ingresa el PIN de este perfil:");
  if(pin===null) return;

  if(!/^\d{4}$/.test(pin)){
    showModal("PIN inv√°lido.");
    return;
  }

  const check = await hashPin(pin);
  if(check !== p.pinHash){
    showModal("PIN incorrecto.");
    return;
  }

  enterProfile(name);
}

/* ---------- UI Perfil ---------- */
function enterProfile(name){
  renderProfileMenu(name);
}

function renderProfileMenu(name){
  const p = state.perfiles[name];
  const nivel = p.nivel;
  const pregNivel = (PREGUNTAS && PREGUNTAS[nivel]) ? PREGUNTAS[nivel] : [];

  mainContent.innerHTML = `
    <div class="card fade-in">
      <h2>${esc(name)}</h2>
      <p class="muted small">Nivel actual: ${nivel.toUpperCase()}</p>

      <div class="card" style="margin-top:10px">
        <div class="muted small">Correctas: ${p.correctas}</div>
        <div class="muted small">Incorrectas: ${p.incorrectas}</div>
        <div class="muted small">Tiempo total: ${formatNum(p.tiempo_total)}s</div>
        <div class="muted small">Promedio por pregunta: ${
          p.total_respuestas ? formatNum(p.tiempo_total/p.total_respuestas) : "0.00"
        } s</div>
        <div class="muted small">Posici√≥n: ${p.idx_pregunta}/${pregNivel.length}</div>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
        <button id="btnContinue" class="btn accent">‚ñ∂ Continuar</button>
        <button id="btnNew" class="btn ghost">üîÅ Nuevo juego</button>
        <button id="btnAny" class="btn ghost" ${p.finished_all?"":"disabled"}>‚≠ê Nivel libre</button>
        <button id="btnBack" class="btn ghost">üîô Cerrar</button>
      </div>
    </div>
  `;

  document.getElementById("btnContinue").onclick = ()=> startLevel(name,false);
  document.getElementById("btnNew").onclick = ()=> startLevel(name,true);
  document.getElementById("btnBack").onclick = ()=> showHome();

  document.getElementById("btnAny").onclick = ()=>{
    if(!p.finished_all){
      showModal("Debes completar todos los niveles primero.");
      return;
    }
    let lvl = prompt("Nivel (basico/medio/avanzado):");
    if(!lvl) return;
    lvl = lvl.toLowerCase();
    if(!["basico","medio","avanzado"].includes(lvl)){
      showModal("Nivel inv√°lido.");
      return;
    }
    // reset stats
    p.nivel = lvl;
    p.correctas = 0;
    p.incorrectas = 0;
    p.tiempo_total = 0;
    p.total_respuestas = 0;
    p.idx_pregunta = 0;
    p.finished_all = false;
    saveState();
    startLevel(name,true);
  };
}

/* ---------- Home ---------- */
function showHome(){
  mainContent.innerHTML = `
    <div class="card fade-in">
      <h2>Bienvenido üëã</h2>
      <p class="muted">
        Selecciona o crea un perfil para comenzar.
      </p>
    </div>
    <div class="card fade-in" style="margin-top:12px">
      <h3>Ranking local</h3>
      <div id="leaderboard" class="leaderboard muted"></div>
    </div>
  `;
  renderLeaderboard();
}

/* ---------- Comenzar nivel ---------- */
let session = {};

function startLevel(name, reset){
  if(!loadedQuestions){
    showModal("Preguntas no cargadas.");
    return;
  }

  const stats = state.perfiles[name];
  const nivel = stats.nivel;
  session.lista = PREGUNTAS[nivel] ? [...PREGUNTAS[nivel]] : [];

  if(reset) stats.idx_pregunta = 0;

  session.idx = stats.idx_pregunta;
  session.counters = {correctas:0, incorrectas:0, omitidas:0};
  session.timer = null;

  renderQuestion(name);
}

/* ---------- Render Pregunta ---------- */
function renderQuestion(name){
  clearInterval(session.timer);

  const p = session.lista[session.idx];
  if(!p){
    finishLevel(name);
    return;
  }

  session.remaining = 60;
  session.startTime = Date.now();

  mainContent.innerHTML = `
    <div class="card fade-in">
      <h3 class="question">${esc(p.pregunta)}</h3>

      <div id="opts" class="options"></div>

      <div class="controls" style="margin-top:12px; display:flex; gap:8px">
        <button id="btnSkip" class="btn ghost small">‚è≠ Omitir</button>
        <button id="btnSave" class="btn ghost small">üíæ Guardar</button>
        <button id="btnBack" class="btn ghost small">üîô Volver</button>
      </div>

      <div class="timerbar">
        <div id="timerFill" class="timerfill"></div>
      </div>

      <p class="muted small">‚è± Tiempo restante: <span id="timeTxt">60</span>s</p>
    </div>
  `;

  const opts = document.getElementById("opts");
  p.opciones.forEach((op,i)=>{
    const b = document.createElement("button");
    b.className = "option-btn";
    b.textContent = `${String.fromCharCode(65+i)}. ${op}`;
    b.onclick = ()=> answer(name,op,b);
    opts.appendChild(b);
  });

  document.getElementById("btnSkip").onclick = ()=> skip(name);
  document.getElementById("btnSave").onclick = ()=>{ saveState(); showModal("Guardado."); };
  document.getElementById("btnBack").onclick = ()=>{ clearInterval(session.timer); renderProfileMenu(name); };

  session.timer = setInterval(()=>{
    session.remaining--;
    document.getElementById("timeTxt").textContent = session.remaining;
    document.getElementById("timerFill").style.width = (session.remaining/60*100)+"%";

    if(session.remaining <= 0){
      clearInterval(session.timer);
      sndTime.play();
      timeOut(name);
    }
  },1000);
}

/* ---------- Responder ---------- */
function answer(name,op,btnEl){
  clearInterval(session.timer);

  const p = session.lista[session.idx];
  const stats = state.perfiles[name];
  const t = (Date.now() - session.startTime)/1000;

  stats.tiempo_total += t;
  stats.total_respuestas++;

  if(op === p.respuesta){
    sndCorrect.play();
    btnEl.classList.add("correct");
    session.counters.correctas++;
    stats.correctas++;
    showModal("‚úî ¬°Correcto!");
  } else {
    sndWrong.play();
    btnEl.classList.add("wrong");
    session.counters.incorrectas++;
    stats.incorrectas++;
    showModal("‚úñ Incorrecto.");
  }

  session.idx++;
  stats.idx_pregunta = session.idx;
  saveState();

  setTimeout(()=> renderQuestion(name), 300);
}

/* ---------- Omitir ---------- */
function skip(name){
  clearInterval(session.timer);
  session.counters.omitidas++;
  session.idx++;
  state.perfiles[name].idx_pregunta = session.idx;
  saveState();
  renderQuestion(name);
}

/* ---------- Timeout ---------- */
function timeOut(name){
  const stats = state.perfiles[name];
  stats.tiempo_total += 60;
  stats.total_respuestas++;
  stats.incorrectas++;
  session.counters.incorrectas++;

  session.idx++;
  stats.idx_pregunta = session.idx;
  saveState();

  showModal("‚è≥ Tiempo agotado. Se marca incorrecta.");
  renderQuestion(name);
}

/* ---------- Fin nivel ---------- */
function finishLevel(name){
  clearInterval(session.timer);
  const stats = state.perfiles[name];
  const total = session.lista.length;
  const score = (session.counters.correctas/total)*100;

  let msg = `
    <strong>Resultados:</strong><br>
    ‚úî Correctas: ${session.counters.correctas}<br>
    ‚úñ Incorrectas: ${session.counters.incorrectas}<br>
    ‚è≠ Omitidas: ${session.counters.omitidas}<br><br>
    <strong>Puntaje:</strong> ${score.toFixed(2)}%
  `;

  const levels = ["basico","medio","avanzado"];

  if(score >= 80){
    msg += "<br><br>üéâ ¬°Aprobaste!";
    if(stats.nivel === "basico") stats.nivel="medio";
    else if(stats.nivel==="medio") stats.nivel="avanzado";
    else stats.finished_all = true;
    stats.idx_pregunta=0;
  } else {
    msg += "<br><br>üîÅ No alcanzaste el 80%. Repite el nivel.";
  }

  saveState();
  updateLeaderboard(name, stats.tiempo_total);

  /* ========== NUEVA L√çNEA: guardar en ranking global ========== */
  try {
    // llamar la funci√≥n para guardar en Firestore (no bloqueante)
    guardarEnRankingGlobal(name, stats.tiempo_total, stats.correctas, stats.incorrectas);
  } catch(e) {
    console.warn("No se pudo guardar en ranking global:", e);
  }
  /* ========================================================== */

  showModal(msg);
  renderProfiles();
  renderLeaderboard();
  renderProfileMenu(name);
}

/* ---------- Ranking local ---------- */
function updateLeaderboard(name, tiempo){
  const i = leaderboard.findIndex(x=>x.name===name);
  if(i>=0) leaderboard[i].tiempo_total = tiempo;
  else leaderboard.push({name, tiempo_total:tiempo});
  leaderboard.sort((a,b)=>a.tiempo_total - b.tiempo_total);
  saveLeader();
}

function renderLeaderboard(){
  leaderboardEl.innerHTML = "";
  if(leaderboard.length===0){
    leaderboardEl.innerHTML = "<div class='muted small'>Sin datos a√∫n.</div>";
    return;
  }

  leaderboard.forEach((r,i)=>{
    const row = document.createElement("div");
    row.className = "leader-row";
    row.innerHTML = `
      <div>${i+1}. <strong>${esc(r.name)}</strong></div>
      <div>${formatNum(r.tiempo_total)}s</div>
    `;
    leaderboardEl.appendChild(row);
  });
}

/* ---------- Exportar / Importar ranking ---------- */
/* Eliminados seg√∫n lo solicitado. */

/* ---------- Tema ---------- */
themeToggle.onchange = ()=> {
  if(themeToggle.checked) document.documentElement.classList.add("light");
  else document.documentElement.classList.remove("light");
};

/* ---------- Inicial ---------- */
renderProfiles();
renderLeaderboard();

/* =========================
   RANKING GLOBAL: FUNCIONES PARA LEER Y MOSTRAR
   (Se usa la misma instancia `db` ya inicializada arriba)
   ========================= */

/* Cargar ranking global (top 30 ordenado por tiempo ascendente) */
async function cargarRankingGlobal() {
  try {
    const snap = await db.collection("ranking")
      .orderBy("tiempo_total", "asc")
      .limit(30)
      .get();

    if (snap.empty) {
      showModal("üåç<br>No hay datos en el ranking global.");
      return;
    }

    let html = `<strong>üåç Ranking global ‚Äî TOP ${snap.size}</strong><br><br>`;
    let posicion = 1;
    snap.forEach(doc => {
      const d = doc.data();
      html += `
        <div class="leader-row">
          <div>${posicion}. <strong>${esc(d.nombre || "Anon")}</strong></div>
          <div>${formatNum(d.tiempo_total || 0)}s</div>
        </div>
      `;
      posicion++;
    });

    // Mostrar dentro del modal bonito (sin bot√≥n cancelar)
    modalMessage.innerHTML = `
      <strong>üåç Ranking global</strong>
      <div style="margin-top:12px; max-height:300px; overflow-y:auto;">
        ${html}
      </div>
    `;
    modalCancel.classList.add("hidden");
    modalOverlay.classList.remove("hidden");
    modalOk.onclick = () => { modalOverlay.classList.add("hidden"); };

  } catch (e) {
    console.error("Error cargando ranking global:", e);
    showModal("‚ùå No se pudo cargar el ranking global.");
  }
}

/* Conectar bot√≥n Ranking global */
btnGlobalRank.onclick = cargarRankingGlobal;

</script>

</body>
</html>
